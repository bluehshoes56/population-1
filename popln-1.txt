-- COMMAND ----------
-- Dashboard Query 1: Monthly Merchant Presence Trends
-- Chart Type: Line Chart (Time Series)
-- X-axis: ref_month, Y-axis: total_merchants, full_presence_merchants
-- Group by: naics3 (top 5 only)

SELECT 
    CONCAT(SUBSTR(CAST(reference_month AS STRING), 1, 4), '-', 
           SUBSTR(CAST(reference_month AS STRING), 5, 2)) as ref_month,
    naics3,
    total_merchants,
    full_presence_count as full_presence_merchants,
    ROUND(pct_full_presence, 1) as full_presence_pct
FROM reference_month_pivot_enhanced
WHERE naics3 IN (
    SELECT naics3 
    FROM (
        SELECT naics3, AVG(total_merchants) as avg_merchants
        FROM reference_month_pivot_enhanced 
        GROUP BY naics3 
        ORDER BY avg_merchants DESC 
        LIMIT 5
    )
)
ORDER BY reference_month, naics3;

-- COMMAND ----------
-- Dashboard Query 2: Merchant Presence Distribution
-- Chart Type: Stacked Bar Chart
-- X-axis: ref_month, Y-axis: merchant_count
-- Stack by: presence_category

SELECT 
    CONCAT(SUBSTR(CAST(reference_month AS STRING), 1, 4), '-', 
           SUBSTR(CAST(reference_month AS STRING), 5, 2)) as ref_month,
    'No Presence (0 months)' as presence_category,
    SUM(no_presence_count) as merchant_count
FROM reference_month_pivot_enhanced
WHERE total_merchants >= 100
GROUP BY reference_month

UNION ALL

SELECT 
    CONCAT(SUBSTR(CAST(reference_month AS STRING), 1, 4), '-', 
           SUBSTR(CAST(reference_month AS STRING), 5, 2)) as ref_month,
    'Low Presence (1-4 months)' as presence_category,
    SUM(low_presence_count) as merchant_count
FROM reference_month_pivot_enhanced
WHERE total_merchants >= 100
GROUP BY reference_month

UNION ALL

SELECT 
    CONCAT(SUBSTR(CAST(reference_month AS STRING), 1, 4), '-', 
           SUBSTR(CAST(reference_month AS STRING), 5, 2)) as ref_month,
    'Medium Presence (5-8 months)' as presence_category,
    SUM(medium_presence_count) as merchant_count
FROM reference_month_pivot_enhanced
WHERE total_merchants >= 100
GROUP BY reference_month

UNION ALL

SELECT 
    CONCAT(SUBSTR(CAST(reference_month AS STRING), 1, 4), '-', 
           SUBSTR(CAST(reference_month AS STRING), 5, 2)) as ref_month,
    'High Presence (9-12 months)' as presence_category,
    SUM(high_presence_count) as merchant_count
FROM reference_month_pivot_enhanced
WHERE total_merchants >= 100
GROUP BY reference_month

UNION ALL

SELECT 
    CONCAT(SUBSTR(CAST(reference_month AS STRING), 1, 4), '-', 
           SUBSTR(CAST(reference_month AS STRING), 5, 2)) as ref_month,
    'Almost Full (13 months)' as presence_category,
    SUM(almost_full_count) as merchant_count
FROM reference_month_pivot_enhanced
WHERE total_merchants >= 100
GROUP BY reference_month

UNION ALL

SELECT 
    CONCAT(SUBSTR(CAST(reference_month AS STRING), 1, 4), '-', 
           SUBSTR(CAST(reference_month AS STRING), 5, 2)) as ref_month,
    'Full Presence (14 months)' as presence_category,
    SUM(full_presence_count) as merchant_count
FROM reference_month_pivot_enhanced
WHERE total_merchants >= 100
GROUP BY reference_month

ORDER BY ref_month, presence_category;

-- COMMAND ----------
-- Dashboard Query 3: Sales Performance by NAICS
-- Chart Type: Bar Chart or Bubble Chart
-- X-axis: naics3, Y-axis: total_sales_billions
-- Size/Color: merchant_count

SELECT 
    naics3,
    SUM(total_sales_all_categories) / 1000000000 as total_sales_billions,
    SUM(total_merchants) as merchant_count,
    AVG(pct_full_presence) as avg_full_presence_pct,
    SUM(total_sales_all_categories) / SUM(total_merchants) as sales_per_merchant
FROM reference_month_pivot_enhanced
WHERE total_merchants >= 50
GROUP BY naics3
ORDER BY total_sales_billions DESC;

-- COMMAND ----------
-- Dashboard Query 4: Retention Rate Analysis
-- Chart Type: Line Chart
-- X-axis: period (current_month to next_month), Y-axis: retention_rate_pct
-- Group by: naics3 (top performers only)

SELECT 
    CONCAT(
        CONCAT(SUBSTR(CAST(current_ref_month AS STRING), 1, 4), '-', 
               SUBSTR(CAST(current_ref_month AS STRING), 5, 2)),
        ' to ',
        CONCAT(SUBSTR(CAST(next_ref_month AS STRING), 1, 4), '-', 
               SUBSTR(CAST(next_ref_month AS STRING), 5, 2))
    ) as period,
    naics3,
    retention_rate_pct,
    merchants_current_month,
    sales_growth_pct_common_merchants
FROM cross_tabulation_enhanced
WHERE merchants_current_month >= 100
AND naics3 IN ('722', '445', '311', '441', '444')  -- Major retail/restaurant categories
ORDER BY current_ref_month, naics3;

-- COMMAND ----------
-- Dashboard Query 5: Monthly KPI Summary
-- Chart Type: Table or KPI Cards
-- Metrics: Total merchants, Full presence %, Sales volume, Avg transaction

SELECT 
    CONCAT(SUBSTR(CAST(reference_month AS STRING), 1, 4), '-', 
           SUBSTR(CAST(reference_month AS STRING), 5, 2)) as ref_month,
    SUM(total_merchants) as total_merchants,
    ROUND(SUM(full_presence_count) * 100.0 / SUM(total_merchants), 1) as full_presence_pct,
    SUM(total_sales_all_categories) / 1000000000 as total_sales_billions,
    ROUND(SUM(total_sales_all_categories) / SUM(total_transactions_all_categories), 2) as avg_sales_per_transaction,
    COUNT(DISTINCT naics3) as active_naics_count
FROM reference_month_pivot_enhanced
WHERE total_merchants >= 50
GROUP BY reference_month
ORDER BY reference_month DESC;

-- COMMAND ----------
-- Dashboard Query 6: NAICS Performance Heatmap
-- Chart Type: Heatmap
-- X-axis: ref_month, Y-axis: naics3, Color: full_presence_pct

SELECT 
    CONCAT(SUBSTR(CAST(reference_month AS STRING), 1, 4), '-', 
           SUBSTR(CAST(reference_month AS STRING), 5, 2)) as ref_month,
    naics3,
    ROUND(pct_full_presence, 1) as full_presence_pct,
    total_merchants,
    CASE 
        WHEN pct_full_presence >= 80 THEN 'Excellent'
        WHEN pct_full_presence >= 60 THEN 'Good'
        WHEN pct_full_presence >= 40 THEN 'Fair'
        ELSE 'Poor'
    END as performance_rating
FROM reference_month_pivot_enhanced
WHERE total_merchants >= 100
ORDER BY reference_month, naics3;

-- COMMAND ----------
-- Dashboard Query 7: Sales Growth Analysis
-- Chart Type: Combo Chart (Bar + Line)
-- Bar: avg_sales_current, avg_sales_next
-- Line: sales_growth_pct

SELECT 
    CONCAT(SUBSTR(CAST(current_ref_month AS STRING), 1, 4), '-', 
           SUBSTR(CAST(current_ref_month AS STRING), 5, 2)) as current_month,
    naics3,
    ROUND(avg_sales_common_current / 1000, 0) as avg_sales_current_k,
    ROUND(avg_sales_common_next / 1000, 0) as avg_sales_next_k,
    sales_growth_pct_common_merchants,
    retention_rate_pct,
    common_merchants
FROM cross_tabulation_enhanced
WHERE merchants_current_month >= 50
ORDER BY current_ref_month, naics3;

-- COMMAND ----------
-- Dashboard Query 8: Top Performing Merchants Summary
-- Chart Type: Table
-- Show only full presence merchants with high performance

SELECT 
    CONCAT(SUBSTR(CAST(reference_month AS STRING), 1, 4), '-', 
           SUBSTR(CAST(reference_month AS STRING), 5, 2)) as ref_month,
    naics3,
    full_presence_merchant_count,
    ROUND(total_sales_full_presence / 1000000, 1) as total_sales_millions,
    ROUND(avg_sales_per_full_presence_merchant / 1000, 0) as avg_sales_per_merchant_k,
    ROUND(avg_monthly_sales_per_merchant / 1000, 0) as monthly_sales_per_merchant_k,
    ROUND(sales_per_txn_full_presence, 2) as sales_per_transaction,
    ROUND(avg_monthly_txn_per_merchant, 0) as monthly_transactions_per_merchant
FROM full_presence_metrics
WHERE full_presence_merchant_count >= 20
ORDER BY reference_month DESC, total_sales_full_presence DESC;

-- COMMAND ----------
-- Dashboard Query 9: Merchant Stability Index
-- Chart Type: Gauge Chart or Score Card
-- Single metric showing overall market stability

SELECT 
    CONCAT(SUBSTR(CAST(reference_month AS STRING), 1, 4), '-', 
           SUBSTR(CAST(reference_month AS STRING), 5, 2)) as ref_month,
    
    -- Stability Score (0-100)
    ROUND(
        (SUM(full_presence_count) * 100.0 / SUM(total_merchants)) * 0.4 +  -- 40% weight on full presence
        (AVG(CASE WHEN retention_rate_pct IS NOT NULL THEN retention_rate_pct ELSE 70 END)) * 0.3 + -- 30% weight on retention
        (CASE WHEN AVG(sales_growth_pct_common_merchants) > 0 THEN 100 ELSE 50 END) * 0.3, -- 30% weight on growth
        1
    ) as stability_index,
    
    SUM(total_merchants) as total_merchants,
    ROUND(SUM(full_presence_count) * 100.0 / SUM(total_merchants), 1) as full_presence_pct,
    COUNT(DISTINCT naics3) as active_industries
    
FROM reference_month_pivot_enhanced rp
LEFT JOIN (
    SELECT current_ref_month, AVG(retention_rate_pct) as retention_rate_pct, 
           AVG(sales_growth_pct_common_merchants) as sales_growth_pct_common_merchants
    FROM cross_tabulation_enhanced 
    GROUP BY current_ref_month
) cr ON rp.reference_month = cr.current_ref_month
WHERE total_merchants >= 50
GROUP BY reference_month
ORDER BY reference_month DESC;
