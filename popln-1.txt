#tt
# COMMAND ----------
# Enhanced 14-Month Rolling Window Analysis with Additional Metrics - CORRECTED

print("Creating enhanced 14-month rolling window analysis with detailed metrics...")

# First, verify the table exists and get sample
print("Checking all_mids table availability:")
spark.sql("SELECT COUNT(*) as record_count FROM all_mids").show()

# First, identify the valid reference months (those with full 14-month windows)
reference_months = spark.sql("""
WITH all_months AS (
    SELECT DISTINCT txn_year_month
    FROM all_mids
    ORDER BY txn_year_month
),
valid_reference_months AS (
    SELECT 
        txn_year_month as reference_month,
        ADD_MONTHS(CAST(CONCAT(SUBSTR(CAST(txn_year_month AS STRING), 1, 4), '-', 
                              SUBSTR(CAST(txn_year_month AS STRING), 5, 2), '-01') AS DATE), -13) as window_start_date,
        txn_year_month as window_end
    FROM all_months
    WHERE txn_year_month >= 202002  -- Start from Feb 2020
),
valid_reference_with_months AS (
    SELECT 
        reference_month,
        CAST(DATE_FORMAT(window_start_date, 'yyyyMM') AS INT) as window_start,
        window_end
    FROM valid_reference_months
)
SELECT * FROM valid_reference_with_months
ORDER BY reference_month
""")

reference_months.createOrReplaceTempView("reference_months")

print("Valid reference months:")
reference_months.show(50)

# COMMAND ----------
# Create comprehensive merchant presence analysis with all metrics

merchant_window_analysis_enhanced = spark.sql("""
WITH merchant_presence_by_window AS (
    SELECT 
        rm.reference_month,
        rm.window_start,
        rm.window_end,
        am.merchant_key,
        am.naics3,
        -- Basic presence metrics
        COUNT(DISTINCT am.txn_year_month) as months_with_sales,
        COUNT(DISTINCT CASE WHEN am.sales > 0 THEN am.txn_year_month END) as months_with_positive_sales,
        
        -- Sales metrics
        COALESCE(SUM(am.sales), 0) as total_sales_in_window,
        COALESCE(AVG(CASE WHEN am.sales > 0 THEN am.sales END), 0) as avg_monthly_sales,
        
        -- Transaction metrics
        COALESCE(SUM(am.total_txn), 0) as total_txn_in_window,
        COALESCE(AVG(CASE WHEN am.total_txn > 0 THEN am.total_txn END), 0) as avg_monthly_txn,
        
        -- Sales per transaction (only for months with transactions)
        CASE WHEN SUM(am.total_txn) > 0 
             THEN SUM(am.sales) / SUM(am.total_txn) 
             ELSE 0 END as sales_per_transaction,
        
        -- Sales per merchant per month (only for months with sales)
        CASE WHEN COUNT(DISTINCT CASE WHEN am.sales > 0 THEN am.txn_year_month END) > 0
             THEN SUM(am.sales) / COUNT(DISTINCT CASE WHEN am.sales > 0 THEN am.txn_year_month END)
             ELSE 0 END as sales_per_merchant_per_active_month,
             
        -- Flag for merchants with positive sales in the window
        CASE WHEN COALESCE(SUM(am.sales), 0) > 0 THEN 1 ELSE 0 END as has_positive_sales
        
    FROM reference_months rm
    LEFT JOIN all_mids am ON am.txn_year_month BETWEEN rm.window_start AND rm.window_end
    WHERE am.merchant_key IS NOT NULL
    GROUP BY rm.reference_month, rm.window_start, rm.window_end, am.merchant_key, am.naics3
),
categorized_presence AS (
    SELECT 
        *,
        CASE 
            WHEN months_with_sales = 0 THEN 'no_presence'
            WHEN months_with_sales BETWEEN 1 AND 4 THEN 'low_presence_1_4'
            WHEN months_with_sales BETWEEN 5 AND 8 THEN 'medium_presence_5_8'
            WHEN months_with_sales BETWEEN 9 AND 12 THEN 'high_presence_9_12'
            WHEN months_with_sales = 13 THEN 'almost_full_13'
            WHEN months_with_sales = 14 THEN 'full_presence_14'
            ELSE 'other'
        END as presence_category
    FROM merchant_presence_by_window
)
SELECT * FROM categorized_presence
ORDER BY reference_month, naics3, merchant_key
""")

merchant_window_analysis_enhanced.createOrReplaceTempView("merchant_window_analysis_enhanced")

print("Sample of enhanced merchant window analysis:")
merchant_window_analysis_enhanced.select(
    "reference_month", "merchant_key", "naics3", "months_with_sales", 
    "total_sales_in_window", "sales_per_merchant_per_active_month", 
    "total_txn_in_window", "sales_per_transaction", "presence_category"
).show(15, truncate=False)

# COMMAND ----------
# Create comprehensive summary with all requested metrics

reference_month_summary_enhanced = spark.sql("""
SELECT 
    reference_month,
    naics3,
    presence_category,
    
    -- Merchant counts
    COUNT(DISTINCT merchant_key) as merchant_count,
    
    -- Sales metrics
    SUM(total_sales_in_window) as total_sales,
    CASE WHEN COUNT(DISTINCT merchant_key) > 0 
         THEN SUM(total_sales_in_window) / COUNT(DISTINCT merchant_key) 
         ELSE 0 END as avg_sales_per_merchant,
    
    -- Sales per merchant per active month (true ratio)
    AVG(sales_per_merchant_per_active_month) as avg_sales_per_merchant_per_active_month,
    
    -- Transaction metrics
    SUM(total_txn_in_window) as total_transactions,
    CASE WHEN COUNT(DISTINCT merchant_key) > 0 
         THEN SUM(total_txn_in_window) / COUNT(DISTINCT merchant_key) 
         ELSE 0 END as avg_txn_per_merchant,
    
    -- Sales per transaction
    CASE WHEN SUM(total_txn_in_window) > 0 
         THEN SUM(total_sales_in_window) / SUM(total_txn_in_window) 
         ELSE 0 END as overall_sales_per_transaction,
    
    -- Presence metrics
    AVG(months_with_sales) as avg_months_with_sales,
    AVG(months_with_positive_sales) as avg_months_with_positive_sales
    
FROM merchant_window_analysis_enhanced
GROUP BY reference_month, naics3, presence_category
ORDER BY reference_month, naics3, presence_category
""")

reference_month_summary_enhanced.createOrReplaceTempView("reference_month_summary_enhanced")

print("Enhanced summary by reference month and presence category:")
reference_month_summary_enhanced.show(30, truncate=False)

# COMMAND ----------
# Create enhanced pivot table with key metrics

reference_month_pivot_enhanced = spark.sql("""
SELECT 
    reference_month,
    naics3,
    
    -- Merchant counts by presence category
    SUM(CASE WHEN presence_category = 'no_presence' THEN merchant_count ELSE 0 END) as no_presence_count,
    SUM(CASE WHEN presence_category = 'low_presence_1_4' THEN merchant_count ELSE 0 END) as low_presence_count,
    SUM(CASE WHEN presence_category = 'medium_presence_5_8' THEN merchant_count ELSE 0 END) as medium_presence_count,
    SUM(CASE WHEN presence_category = 'high_presence_9_12' THEN merchant_count ELSE 0 END) as high_presence_count,
    SUM(CASE WHEN presence_category = 'almost_full_13' THEN merchant_count ELSE 0 END) as almost_full_count,
    SUM(CASE WHEN presence_category = 'full_presence_14' THEN merchant_count ELSE 0 END) as full_presence_count,
    SUM(merchant_count) as total_merchants,
    
    -- Total sales and transactions
    SUM(total_sales) as total_sales_all_categories,
    SUM(total_transactions) as total_transactions_all_categories,
    
    -- Overall ratios
    CASE WHEN SUM(merchant_count) > 0 
         THEN SUM(total_sales) / SUM(merchant_count) 
         ELSE 0 END as avg_sales_per_merchant_overall,
         
    CASE WHEN SUM(total_transactions) > 0 
         THEN SUM(total_sales) / SUM(total_transactions) 
         ELSE 0 END as avg_sales_per_transaction_overall,
         
    -- Percentage distributions
    CASE WHEN SUM(merchant_count) > 0 
         THEN ROUND(SUM(CASE WHEN presence_category = 'full_presence_14' THEN merchant_count ELSE 0 END) * 100.0 / SUM(merchant_count), 1) 
         ELSE 0 END as pct_full_presence,
         
    CASE WHEN SUM(merchant_count) > 0 
         THEN ROUND((SUM(CASE WHEN presence_category IN ('high_presence_9_12', 'almost_full_13', 'full_presence_14') THEN merchant_count ELSE 0 END)) * 100.0 / SUM(merchant_count), 1) 
         ELSE 0 END as pct_high_presence_9_plus

FROM reference_month_summary_enhanced
GROUP BY reference_month, naics3
ORDER BY reference_month, naics3
""")

reference_month_pivot_enhanced.createOrReplaceTempView("reference_month_pivot_enhanced")

print("Enhanced pivot table with all metrics:")
reference_month_pivot_enhanced.show(20, truncate=False)

# COMMAND ----------
